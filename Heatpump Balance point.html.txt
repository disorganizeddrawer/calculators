<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Heat Pump Balance Point Calculator</title>
  <style>
    :root{--bg:#0b0f14;--panel:#121820;--muted:#9fb0c0;--txt:#e9f0f6;--accent:#3aa1ff;--ok:#19c37d;--danger:#ff5a5f;--card:#0f141b;--border:#1e2630}
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,sans-serif}
    body{margin:0;background:var(--bg);color:var(--txt)}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px}
    .header{justify-content:space-between;margin-bottom:12px}
    .brand{font-weight:700;letter-spacing:.3px}
    .badge{padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:var(--card);color:var(--muted);font-size:14px}
    .btn{background:#182230;color:var(--txt);border:1px solid var(--border);padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn.primary{background:var(--accent);border-color:#2b77bb;color:#07121c}
    .btn:active{transform:translateY(1px)}
    .muted{color:var(--muted)}
    canvas{width:100%;height:320px;display:block;background:#0b1117;border:1px solid var(--border);border-radius:10px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:920px){ .grid{grid-template-columns:1.05fr .95fr;} }
    .field{display:flex;flex-direction:column;gap:6px;min-width:180px}
    label{font-size:12px;color:var(--muted)}
    input{background:#0b1117;border:1px solid var(--border);color:var(--txt);border-radius:10px;padding:10px 10px;font-size:14px;outline:none}
    input:focus{border-color:#2b77bb}
    .table{width:100%;border-collapse:separate;border-spacing:0 8px;margin-top:6px}
    .table th{font-size:12px;color:var(--muted);text-align:left;padding:0 8px}
    .table td{background:var(--card);border:1px solid var(--border);border-left:none;border-right:none;padding:10px 8px}
    .table tr td:first-child{border-left:1px solid var(--border);border-radius:10px 0 0 10px}
    .table tr td:last-child{border-right:1px solid var(--border);border-radius:0 10px 10px 0}
    .kpi{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end}
    .kpi .big{font-size:44px;font-weight:800;line-height:1}
    .kpi .big small{font-size:18px;color:var(--muted);font-weight:600;margin-left:6px}
    .pill{padding:8px 10px;border-radius:12px;border:1px solid var(--border);background:var(--card);color:var(--muted);font-size:13px}
    .legend{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .sw{display:inline-block;width:10px;height:10px;border-radius:3px;margin-right:6px;vertical-align:middle}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="row header">
      <div class="row">
        <span class="brand">Balance Point</span>
        <span class="badge">BTU/h vs Outdoor Temp</span>
      </div>
      <div class="row">
        <button class="btn primary" id="btnCalc">Recalculate</button>
        <button class="btn" id="btnReset">Reset</button>
      </div>
    </div>

    <div class="grid">
      <div class="panel">
        <canvas id="chart" width="920" height="320"></canvas>
        <div class="legend muted">
          <span><span class="sw" style="background:#ff5a5f"></span>Heat output (fit)</span>
          <span><span class="sw" style="background:#ffd24d"></span>Output points</span>
          <span><span class="sw" style="background:#3aa1ff"></span>Heat demand</span>
          <span><span class="sw" style="background:#19c37d"></span>Balance temp</span>
        </div>
      </div>

      <div class="panel">
        <div class="kpi">
          <div>
            <div class="muted" style="font-size:12px;margin-bottom:6px">Result</div>
            <div class="big" id="bpOut">—<small>°F</small></div>
          </div>
          <div class="pill" id="bpNote">Enter points → Recalculate</div>
        </div>

        <div style="height:10px"></div>

        <div class="row">
          <div class="field">
            <label for="designTempF">Design outdoor temp (°F)</label>
            <input id="designTempF" type="number" step="0.1" value="-4" />
          </div>
          <div class="field">
            <label for="heatDemandBtu">Heat demand at design temp (BTU/h)</label>
            <input id="heatDemandBtu" type="number" step="100" value="32000" />
          </div>
        </div>

        <div class="muted" style="margin-top:10px;font-size:13px">
          Demand line is forced through <strong>(65°F, 0)</strong> and the design point.
        </div>

        <div style="height:10px"></div>

        <div class="muted" style="font-size:13px;margin-bottom:6px">
          Heat output points (2 to 4). Fit is a straight line (least-squares if 3–4 points).
        </div>

        <table class="table">
          <thead>
            <tr>
              <th style="width:60px">Use</th>
              <th>Temp (°F)</th>
              <th>Output (BTU/h)</th>
            </tr>
          </thead>
          <tbody id="ptBody"></tbody>
        </table>

        <div class="muted" style="margin-top:8px;font-size:12px">
          Axes fixed: X = -22 → 90°F, Y = 0 → 60,000 BTU/h.
        </div>
      </div>
    </div>
  </div>

<script>
  // Style reference: adapted to match the look/feel of the provided demo HTML. :contentReference[oaicite:0]{index=0}

  const XMIN = -22, XMAX = 90;
  const YMIN = 0,   YMAX = 60000;

  const $ = (id) => document.getElementById(id);

  const canvas = $("chart");
  const ctx = canvas.getContext("2d");

  function clamp(v, lo, hi){ v = Number(v); if(!isFinite(v)) v = 0; return Math.max(lo, Math.min(hi, v)); }

  function makePointRow(i, use=true, t=0, q=0){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>
        <input type="checkbox" class="use" ${use ? "checked":""} aria-label="use point ${i+1}" />
      </td>
      <td><input type="number" class="t" step="0.1" value="${t}" /></td>
      <td><input type="number" class="q" step="100" value="${q}" /></td>
    `;
    return tr;
  }

  function initTable(){
    const body = $("ptBody");
    body.innerHTML = "";
    // Default 4 rows; user can uncheck to use 2–4
    body.appendChild(makePointRow(0, true,  47, 36000));
    body.appendChild(makePointRow(1, true,  17, 30000));
    body.appendChild(makePointRow(2, true,   5, 26000));
    body.appendChild(makePointRow(3, false, -5, 22000));
  }

  function readOutputPoints(){
    const rows = Array.from($("ptBody").querySelectorAll("tr"));
    const pts = [];
    for(const r of rows){
      const use = r.querySelector(".use").checked;
      const t = Number(r.querySelector(".t").value);
      const q = Number(r.querySelector(".q").value);
      if(use && isFinite(t) && isFinite(q)) pts.push({x:t, y:q});
    }
    // Require 2..4
    return pts;
  }

  function fitLineLeastSquares(pts){
    // Returns {m,b} for y = m x + b; handles 2 points exactly too.
    const n = pts.length;
    let sx=0, sy=0, sxx=0, sxy=0;
    for(const p of pts){ sx += p.x; sy += p.y; sxx += p.x*p.x; sxy += p.x*p.y; }
    const denom = (n*sxx - sx*sx);
    if(Math.abs(denom) < 1e-12){
      // Vertical-ish / degenerate: fall back to small slope
      return {m:0, b: sy/n};
    }
    const m = (n*sxy - sx*sy) / denom;
    const b = (sy - m*sx) / n;
    return {m,b};
  }

  function demandLine(designTempF, demandBtu){
    // Forced through (65,0) and (designTempF, demandBtu)
    const x1 = 65, y1 = 0;
    const x2 = designTempF, y2 = demandBtu;
    const dx = (x2 - x1);
    if(Math.abs(dx) < 1e-9){
      return {m:0, b:y2}; // avoid blow-up (rare)
    }
    const m = (y2 - y1) / dx;
    const b = y1 - m*x1;
    return {m,b};
  }

  function intersect(l1, l2){
    // y=m1x+b1 = m2x+b2 -> x=(b2-b1)/(m1-m2)
    const dm = (l1.m - l2.m);
    if(Math.abs(dm) < 1e-12) return null;
    const x = (l2.b - l1.b) / dm;
    const y = l1.m * x + l1.b;
    return {x, y};
  }

  function plotFrame(){
    const w = canvas.width, h = canvas.height;
    const L = 56, R = 16, T = 14, B = 36;
    const W = w - L - R, H = h - T - B;

    ctx.clearRect(0,0,w,h);

    // Grid
    ctx.strokeStyle = "#233041";
    ctx.lineWidth = 1;
    for(let i=0;i<=6;i++){
      const yy = T + H - (i/6)*H;
      ctx.beginPath(); ctx.moveTo(L,yy); ctx.lineTo(L+W,yy); ctx.stroke();
    }
    for(let i=0;i<=8;i++){
      const xx = L + (i/8)*W;
      ctx.beginPath(); ctx.moveTo(xx,T); ctx.lineTo(xx,T+H); ctx.stroke();
    }

    // Axes
    ctx.strokeStyle = "#4b617a";
    ctx.lineWidth = 1.4;
    ctx.beginPath(); ctx.moveTo(L,T); ctx.lineTo(L,T+H); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(L,T+H); ctx.lineTo(L+W,T+H); ctx.stroke();

    // Labels
    ctx.fillStyle = "#9fb0c0";
    ctx.font = "11px system-ui";

    // Y ticks (0..60000)
    for(let i=0;i<=6;i++){
      const v = Math.round((i/6)*(YMAX-YMIN)+YMIN);
      const yy = T + H - (i/6)*H;
      ctx.fillText(v.toLocaleString(), 8, yy+4);
    }

    // X ticks (-22..90)
    for(let i=0;i<=8;i++){
      const v = (i/8)*(XMAX-XMIN)+XMIN;
      const xx = L + (i/8)*W;
      ctx.fillText(v.toFixed(0), xx-8, T+H+20);
    }

    // Axis titles
    ctx.fillText("BTU/h", 10, T+10);
    ctx.fillText("Outdoor Temp (°F)", L + W - 120, T+H+32);

    function sx(x){ return L + ((x - XMIN) / (XMAX - XMIN)) * W; }
    function sy(y){ return T + (1 - (y - YMIN) / (YMAX - YMIN)) * H; }

    return {L,R,T,B,W,H,sx,sy};
  }

  function drawLine(line, color, frame){
    // Draw y=m x + b across XMIN..XMAX, clipped to plotting rect.
    const xA = XMIN, yA = line.m*xA + line.b;
    const xB = XMAX, yB = line.m*xB + line.b;

    ctx.strokeStyle = color;
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(frame.sx(xA), frame.sy(yA));
    ctx.lineTo(frame.sx(xB), frame.sy(yB));
    ctx.stroke();
  }

  function drawPoints(pts, frame){
    ctx.fillStyle = "#ffd24d";
    for(const p of pts){
      ctx.beginPath();
      ctx.arc(frame.sx(p.x), frame.sy(p.y), 4, 0, Math.PI*2);
      ctx.fill();
      ctx.strokeStyle = "#0b1117";
      ctx.lineWidth = 1;
      ctx.stroke();
    }
  }

  function drawVertical(x, color, frame){
    ctx.strokeStyle = color;
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(frame.sx(x), frame.sy(YMIN));
    ctx.lineTo(frame.sx(x), frame.sy(YMAX));
    ctx.stroke();
  }

  function update(){
    const pts = readOutputPoints();
    const designTempF = Number($("designTempF").value);
    const heatDemandBtu = Number($("heatDemandBtu").value);

    const frame = plotFrame();

    // Always draw demand line if inputs are valid-ish
    const dem = demandLine(designTempF, heatDemandBtu);
    drawLine(dem, "#3aa1ff", frame);

    // Output line requires 2..4 points
    if(pts.length < 2 || pts.length > 4){
      $("bpOut").innerHTML = "—<small>°F</small>";
      $("bpNote").textContent = "Need 2–4 output points (check the Use boxes).";
      drawPoints(pts, frame);
      return;
    }

    // Fit output line + draw
    const out = fitLineLeastSquares(pts);
    drawLine(out, "#ff5a5f", frame);
    drawPoints(pts, frame);

    // Intersection
    const hit = intersect(out, dem);
    if(!hit || !isFinite(hit.x) || !isFinite(hit.y)){
      $("bpOut").innerHTML = "—<small>°F</small>";
      $("bpNote").textContent = "Lines are parallel/degenerate (no unique balance point).";
      return;
    }

    // Mark vertical balance line
    drawVertical(hit.x, "#19c37d", frame);

    // Report
    const inRange = (hit.x >= XMIN && hit.x <= XMAX);
    const bpF = hit.x;
    $("bpOut").innerHTML = `${bpF.toFixed(1)}<small>°F</small>`;
    $("bpNote").textContent = inRange
      ? "Balance point is within the plot range."
      : "Balance point is outside the plot range (still shown as a vertical line if visible).";
  }

  $("btnCalc").addEventListener("click", update);
  $("btnReset").addEventListener("click", () => { initTable(); $("designTempF").value=-4; $("heatDemandBtu").value=32000; update(); });

  // Live recalc on edits
  document.addEventListener("input", (e) => {
    if(e.target.closest("#ptBody") || e.target.id==="designTempF" || e.target.id==="heatDemandBtu"){
      update();
    }
  });

  initTable();
  update();
</script>
</body>
</html>
